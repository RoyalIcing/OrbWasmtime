defmodule OrbWasmtime.Instance.InstanceTest do
  use ExUnit.Case, async: true

  alias OrbWasmtime.Instance
  alias OrbWasmtime.Wasm

  test "run_instance with wat via wat2wasm" do
    wat_source = """
    (module $single_func
      (func (export "answer") (result i32)
       i32.const 42
      )
    )
    """

    wasm_source = wat_source |> Wasm.to_wasm()
    assert wasm_source =~ "\0asm"

    instance = Instance.run(wasm_source)
    assert Instance.call(instance, "answer") == 42
  end

  test "run_instance with wasm" do
    wasm_source =
      <<"\0asm", 0x01000000::32>> <>
        <<0x01, 0x07, 0x01, (<<0x60, 0x02, 0x7E, 0x7E, 0x01, 0x7E>>)>> <>
        <<0x03, 0x02, 0x01, 0x00>> <>
        <<0x07, 0x08, 0x01, 0x04, "math", 0x00, 0x00>> <>
        <<0x0A, 0x18, 0x01, 0x16, <<0x01, 0x01, 0x7E>>,
          <<"", <<0x42, 0x04>>, <<0x20, 0x00>>, 0x7C, <<0x20, 0x01>>, 0x7D>>, <<0x21, 0x02>>,
          <<"", <<0x20, 0x00>>, <<0x20, 0x01>>, 0x7E, <<0x20, 0x02>>, 0x7F>>, 0x0B>>

    instance = Instance.run(wasm_source)
    assert Instance.call(instance, "math", {:i64, 11}, {:i64, 7}) == 9
  end

  test "run_instance with wasm 2" do
    # 0x72, 0x65, 0x61, 0x64, 0x5F, 0x75, 0x38

    wasm_source =
      <<"\0asm", 0x01000000::32>> <>
        <<0x1, 0x6, 0x1, 0x60, 0x1, 0x7F, 0x1, 0x7F, 0x3, 0x3, 0x2, 0x0, 0x0, 0x5, 0x3, 0x1, 0x0,
          0x1, 0x7, 0x1F, 0x3, 0x6, 0x6D, 0x65, 0x6D, 0x6F, 0x72, 0x79, 0x2, 0x0, 0x7, "read_u8",
          0x0, 0x0, 0x8, "read_i32", 0x0, 0x1, 0xA, 0x11, 0x2, 0x7, 0x0, 0x20, 0x0, 0x2D, 0x0,
          0x0, 0xB, 0x7, 0x0, 0x20, 0x0, 0x28, 0x2, 0x0, 0xB, 0xB, 0x40, 0x6, 0x0, 0x41, 0x80,
          0x2, 0xB, 0x3, 0x61, 0x62, 0x63, 0x0, 0x41, 0x80, 0x4, 0xB, 0x3, 0x64, 0x65, 0x66, 0x0,
          0x41, 0x80, 0x6, 0xB, 0x4, 0x1, 0x2, 0x3, 0x4, 0x0, 0x41, 0x80, 0x8, 0xB, 0x1, 0x7B,
          0x0, 0x41, 0x80, 0xA, 0xB, 0x4, 0x4, 0x10, 0x3, 0xC, 0x0, 0x41, 0x80, 0xC, 0xB, 0xC,
          0x4, 0x0, 0x0, 0x0, 0x40, 0xE2, 0x1, 0x0, 0x3, 0x0, 0x0, 0x0>>

    instance = Instance.run(wasm_source)
    assert 1 = Instance.call(instance, "read_u8", 0x300)
  end
end
